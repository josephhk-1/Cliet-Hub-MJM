<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Hub - مدير العملاء</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --toast-bg: #1f2937;
            --toast-text-color: #f9fafb;
        }
        [dir="ltr"] { font-family: 'Inter', sans-serif; }
        [dir="rtl"] { font-family: 'Tajawal', sans-serif; }
        .kanban-column { min-height: 200px; }
        .task-card { 
            touch-action: manipulation; 
            position: relative;
            border-left-width: 4px;
            transition: box-shadow 0.2s ease-in-out;
        }
        .task-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .task-card[data-status="todo"] { border-left-color: #9ca3af; }
        .task-card[data-status="inprogress"] { border-left-color: #3b82f6; }
        .task-card[data-status="done"] { border-left-color: #22c55e; }

        .task-card:hover .task-actions { opacity: 1; }
        .task-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        [dir="rtl"] .task-actions {
            right: auto;
            left: 4px;
        }
        .dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        .drag-over {
            background-color: rgba(34, 197, 94, 0.1);
            border: 2px dashed rgba(34, 197, 94, 0.4);
        }
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background-color: var(--toast-bg);
            color: var(--toast-text-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast.show { bottom: 20px; }
        .client-item.selected {
            background-color: #e5e7eb; /* bg-gray-200 */
            border-right: 3px solid #1f2937; /* border-gray-800 */
        }
        [dir="rtl"] .client-item.selected {
            border-right: none;
            border-left: 3px solid #1f2937;
        }
        .progress-bar { transition: width 0.3s ease; }
        #clear-search-btn { display: none; }

        /* Status changer dropdown */
        .status-change-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            z-index: 10;
            width: 120px;
            overflow: hidden;
            transform-origin: top right;
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
        }
         [dir="rtl"] .status-change-dropdown {
            right: auto;
            left: 0;
            transform-origin: top left;
        }
        .status-change-dropdown.hidden {
            transform: scale(0.95);
            opacity: 0;
            pointer-events: none;
        }
        .status-change-dropdown button {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            text-align: left;
        }
         [dir="rtl"] .status-change-dropdown button {
            text-align: right;
        }
        .status-change-dropdown button:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application Container -->
    <div id="app" class="flex flex-col h-screen">

        <!-- Header -->
        <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center shadow-sm">
            <div><h1 class="text-2xl font-bold text-gray-800" data-translate="appTitle">Client Hub</h1></div>
            <div class="flex items-center space-x-2 md:space-x-4">
                <div id="hub-info-container" class="hidden items-center space-x-2 bg-gray-100 px-3 py-1.5 rounded-lg">
                    <span class="text-sm font-medium text-gray-600" data-translate="hubIdLabel">HUB ID:</span>
                    <span id="hub-id-display" class="text-sm font-semibold text-gray-800"></span>
                    <button id="copy-hub-link-btn" class="p-1 text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
                <button id="share-btn" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                    <span data-translate="share">Share</span>
                </button>
                <div class="flex items-center border border-gray-300 rounded-lg p-1">
                    <button id="lang-en" class="px-3 py-1 text-sm rounded-md bg-gray-700 text-white">EN</button>
                    <button id="lang-ar" class="px-3 py-1 text-sm rounded-md">AR</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex overflow-hidden">
            <!-- Left Panel: Clients List -->
            <aside id="client-list-panel" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-gray-200 flex flex-col transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0 absolute md:relative z-20 h-full">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold" data-translate="clients">Clients</h2>
                        <button id="add-client-btn" class="bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            <span data-translate="addClient">Add Client</span>
                        </button>
                    </div>
                     <div class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <textarea id="ai-client-setup-input" class="w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm" rows="2" data-translate-placeholder="pasteClientInfoPlaceholder" placeholder="Paste client info..."></textarea>
                        <button id="ai-client-setup-btn" class="mt-2 w-full bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 flex items-center justify-center gap-2 transition-colors">
                             ✨ <span data-translate="setupWithAI">Setup with AI</span>
                        </button>
                    </div>
                    <div class="relative"><input type="text" id="client-search" placeholder="Search clients..." data-translate-placeholder="searchPlaceholder" class="w-full border border-gray-300 rounded-md p-2 pl-10 focus:ring-gray-500 focus:border-gray-500">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    <button id="clear-search-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    </div>
                </div>
                <div id="clients-list" class="flex-1 overflow-y-auto"><div id="loader-clients" class="p-4 text-center"><span class="h-6 w-6 border-t-2 border-gray-600 rounded-full animate-spin inline-block"></span></div></div>
                <div class="md:hidden p-2 border-t"><button id="close-panel-btn" class="w-full text-center text-sm py-2" data-translate="close">Close</button></div>
            </aside>

            <!-- Right Panel: Client Details -->
            <section class="flex-1 flex flex-col bg-gray-100 overflow-y-auto">
                <div class="md:hidden p-4 border-b bg-white"><button id="open-panel-btn" class="flex items-center space-x-2 rtl:space-x-reverse text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg><span data-translate="clients">Clients</span></button></div>
                <div id="client-details-view" class="hidden"></div>
                <div id="empty-state" class="flex-1 flex items-center justify-center text-center p-8"><div><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg><h3 class="mt-2 text-lg font-medium text-gray-900" data-translate="selectClientTitle">Select a client</h3><p class="mt-1 text-sm text-gray-500" data-translate="selectClientDesc">Select a client from the list to see their details, or add a new one.</p></div></div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="client-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 border-b"><h3 id="client-modal-title" class="text-xl font-semibold" data-translate="addClient">Add New Client</h3></div>
            <form id="client-form" class="p-6 space-y-4">
                <input type="hidden" id="client-id">
                <div><label for="client-name" class="block text-sm font-medium text-gray-700" data-translate="clientName">Client Name</label><input type="text" id="client-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
                <div><label for="client-company" class="block text-sm font-medium text-gray-700" data-translate="clientCompany">Company</label><input type="text" id="client-company" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="client-email" class="block text-sm font-medium text-gray-700" data-translate="clientEmail">Email</label><input type="email" id="client-email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="client-phone" class="block text-sm font-medium text-gray-700" data-translate="clientPhone">Phone</label><input type="tel" id="client-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="client-notes" class="block text-sm font-medium text-gray-700" data-translate="notes">Notes</label><textarea id="client-notes" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea></div>
            </form>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rtl:space-x-reverse">
                <button id="cancel-client-btn" type="button" class="bg-white py-2 px-4 border border-gray-300 rounded-md text-sm font-medium" data-translate="cancel">Cancel</button>
                <button id="save-client-btn" type="submit" form="client-form" class="bg-gray-800 text-white py-2 px-4 rounded-md text-sm font-medium" data-translate="save">Save Client</button>
            </div>
        </div>
    </div>
    
    <div id="task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-semibold p-6 border-b" data-translate="addTask">Add New Task</h3>
            <form id="task-form" class="p-6">
                <label for="task-text" class="block text-sm font-medium text-gray-700" data-translate="taskDescription">Task Description</label>
                <input type="text" id="task-text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
            </form>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rtl:space-x-reverse">
                <button id="cancel-task-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md text-sm font-medium" data-translate="cancel">Cancel</button>
                <button id="save-task-btn" type="submit" form="task-form" class="bg-gray-800 text-white py-2 px-4 rounded-md text-sm font-medium" data-translate="saveTask">Save Task</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <svg class="mx-auto h-12 w-12 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                <h3 id="confirm-modal-title" class="text-lg font-semibold mt-4"></h3>
                <p id="confirm-modal-text" class="text-sm text-gray-600 mt-2"></p>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-center space-x-3 rtl:space-x-reverse">
                <button id="confirm-cancel-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md text-sm font-medium" data-translate="cancel">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-red-700" data-translate="delete">Delete</button>
            </div>
        </div>
    </div>
    
    <div id="upload-progress-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-semibold text-center" data-translate="uploadingFile">Uploading File...</h3>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
            </div>
            <p id="upload-progress-text" class="text-center text-sm text-gray-600 mt-2">0%</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfigFromModule = {
            apiKey: "AIzaSyBd-qKC_YUO9F3-Oh1WzgPi2osFaLO8G8Y",
            authDomain: "cliet-hub-mjm.firebaseapp.com",
            projectId: "cliet-hub-mjm",
            storageBucket: "cliet-hub-mjm.appspot.com",
            messagingSenderId: "416845101627",
            appId: "1:416845101627:web:6259b28c1632554d7dba1e",
            measurementId: "G-MGSP9CGS82"
        };

        // --- App State ---
        let currentLanguage = 'en';
        let clients = [];
        let selectedClientId = null;
        let db, auth, storage;
        let hubId = null;
        let clientsUnsubscribe = null;
        let confirmCallback = null;

        const uiStrings = {
            en: {
                appTitle: "Client Hub", clients: "Clients", addClient: "Add Client",
                selectClientTitle: "Select a client", selectClientDesc: "Select a client from the list to see their details, or create a new hub to get started.",
                loading: "Loading...", addClientTitle: "Add New Client", editClientTitle: "Edit Client",
                clientName: "Client Name", clientEmail: "Email", clientPhone: "Phone", notes: "Notes", clientCompany: "Company",
                cancel: "Cancel", save: "Save Client", edit: "Edit", delete: "Delete", tasks: "Tasks",
                todo: "To Do", inprogress: "In Progress", done: "Done", addTask: "Add Task",
                taskDescription: "Task Description", saveTask: "Save Task",
                confirmDeleteClientTitle: "Delete Client?", confirmDeleteClientText: "This will permanently delete the client and all associated tasks and files. This action cannot be undone.",
                confirmDeleteTaskTitle: "Delete Task?", confirmDeleteTaskText: "This will permanently delete this task. Are you sure?",
                confirmDeleteFileTitle: "Delete File?", confirmDeleteFileText: "This will permanently delete this file. Are you sure?",
                clientSaved: "Client saved successfully.", clientDeleted: "Client deleted.",
                taskAdded: "Task added successfully.", taskDeleted: "Task deleted.", error: "An error occurred.",
                taskStatusUpdated: "Task status updated.",
                close: "Close", hubIdLabel: "HUB ID:", share: "Share",
                searchPlaceholder: "Search clients...", noClientsFound: "No clients found.",
                files: "Files", uploadFile: "Upload File", uploadingFile: "Uploading File...",
                fileUploaded: "File uploaded successfully.", fileDeleted: "File deleted.",
                exportPDF: "Export PDF", exportExcel: "Export Excel",
                firebaseConfigError: "Firebase config error.", firebaseNotInitialized: "Database connection failed. Check configuration.",
                linkCopied: "Shareable link copied to clipboard!",
                breakDownGoal: "✨ Break Down Goal",
                enterGoalPlaceholder: "Enter a project goal to break down with AI...",
                generatingTasks: "Generating...",
                tasksGenerated: "AI tasks have been added!",
                setupWithAI: "Setup with AI",
                pasteClientInfoPlaceholder: "Paste client info (e.g., email signature) to setup with AI...",
                parsingClientInfo: "Parsing...",
                clientInfoParsed: "Client info parsed successfully!"
            },
            ar: {
                appTitle: "مدير العملاء", clients: "العملاء", addClient: "إضافة عميل",
                selectClientTitle: "اختر عميل", selectClientDesc: "اختر عميلًا من القائمة لرؤية تفاصيله، أو أنشئ مركزًا جديدًا للبدء.",
                loading: "جاري التحميل...", addClientTitle: "إضافة عميل جديد", editClientTitle: "تعديل العميل",
                clientName: "اسم العميل", clientEmail: "البريد الإلكتروني", clientPhone: "الهاتف", notes: "ملاحظات", clientCompany: "الشركة",
                cancel: "إلغاء", save: "حفظ العميل", edit: "تعديل", delete: "حذف", tasks: "المهام",
                todo: "مهام جديدة", inprogress: "قيد التنفيذ", done: "مكتملة", addTask: "إضافة مهمة",
                taskDescription: "وصف المهمة", saveTask: "حفظ المهمة",
                confirmDeleteClientTitle: "حذف العميل؟", confirmDeleteClientText: "سيؤدي هذا إلى حذف العميل وجميع المهام والملفات المرتبطة به بشكل دائم. لا يمكن التراجع عن هذا الإجراء.",
                confirmDeleteTaskTitle: "حذف المهمة؟", confirmDeleteTaskText: "سيؤدي هذا إلى حذف هذه المهمة نهائيًا. هل أنت متأكد؟",
                confirmDeleteFileTitle: "حذف الملف؟", confirmDeleteFileText: "سيؤدي هذا إلى حذف هذا الملف نهائيًا. هل أنت متأكد؟",
                clientSaved: "تم حفظ العميل بنجاح.", clientDeleted: "تم حذف العميل.",
                taskAdded: "تمت إضافة المهمة بنجاح.", taskDeleted: "تم حذف المهمة.", error: "حدث خطأ ما.",
                taskStatusUpdated: "تم تحديث حالة المهمة.",
                close: "إغلاق", hubIdLabel: "معرف المركز:", share: "مشاركة",
                searchPlaceholder: "ابحث عن عملاء...", noClientsFound: "لم يتم العثور على عملاء.",
                files: "الملفات", uploadFile: "رفع ملف", uploadingFile: "جاري رفع الملف...",
                fileUploaded: "تم رفع الملف بنجاح.", fileDeleted: "تم حذف الملف.",
                exportPDF: "تصدير PDF", exportExcel: "تصدير Excel",
                firebaseConfigError: "خطأ في إعدادات Firebase.", firebaseNotInitialized: "فشل الاتصال بقاعدة البيانات. يرجى التحقق من الإعدادات.",
                linkCopied: "تم نسخ رابط المشاركة إلى الحافظة!",
                breakDownGoal: "✨ تحليل الهدف",
                enterGoalPlaceholder: "أدخل هدف المشروع لتحليله بالذكاء الاصطناعي...",
                generatingTasks: "جاري الإنشاء...",
                tasksGenerated: "تمت إضافة مهام الذكاء الاصطناعي!",
                setupWithAI: "إعداد بالذكاء الاصطناعي",
                pasteClientInfoPlaceholder: "الصق معلومات العميل (مثل توقيع البريد الإلكتروني) للإعداد بالذكاء الاصطناعي...",
                parsingClientInfo: "جاري التحليل...",
                clientInfoParsed: "تم تحليل معلومات العميل بنجاح!"
            }
        };

        const elements = {
            app: document.getElementById('app'),
            langEnBtn: document.getElementById('lang-en'),
            langArBtn: document.getElementById('lang-ar'),
            clientsList: document.getElementById('clients-list'),
            clientDetailsView: document.getElementById('client-details-view'),
            emptyState: document.getElementById('empty-state'),
            addClientBtn: document.getElementById('add-client-btn'),
            clientSearch: document.getElementById('client-search'),
            clearSearchBtn: document.getElementById('clear-search-btn'),
            aiClientSetupInput: document.getElementById('ai-client-setup-input'),
            aiClientSetupBtn: document.getElementById('ai-client-setup-btn'),
            clientModal: document.getElementById('client-modal'),
            clientModalTitle: document.getElementById('client-modal-title'),
            clientForm: document.getElementById('client-form'),
            clientIdInput: document.getElementById('client-id'),
            clientNameInput: document.getElementById('client-name'),
            clientCompanyInput: document.getElementById('client-company'),
            clientEmailInput: document.getElementById('client-email'),
            clientPhoneInput: document.getElementById('client-phone'),
            clientNotesInput: document.getElementById('client-notes'),
            cancelClientBtn: document.getElementById('cancel-client-btn'),
            taskModal: document.getElementById('task-modal'),
            taskForm: document.getElementById('task-form'),
            taskTextInput: document.getElementById('task-text'),
            cancelTaskBtn: document.getElementById('cancel-task-btn'),
            toast: document.getElementById('toast'),
            loaderClients: document.getElementById('loader-clients'),
            hubInfoContainer: document.getElementById('hub-info-container'),
            hubIdDisplay: document.getElementById('hub-id-display'),
            copyHubLinkBtn: document.getElementById('copy-hub-link-btn'),
            shareBtn: document.getElementById('share-btn'),
            clientListPanel: document.getElementById('client-list-panel'),
            openPanelBtn: document.getElementById('open-panel-btn'),
            closePanelBtn: document.getElementById('close-panel-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalText: document.getElementById('confirm-modal-text'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            uploadProgressModal: document.getElementById('upload-progress-modal'),
            uploadProgressBar: document.getElementById('upload-progress-bar'),
            uploadProgressText: document.getElementById('upload-progress-text'),
        };

        /**
         * Creates a DOM element with specified tag, classes, and text content.
         * @param {string} tag - The HTML tag for the element.
         * @param {string[]|string} classes - A string or array of strings for CSS classes.
         * @param {string} [textContent] - The text content for the element.
         * @returns {HTMLElement} The created DOM element.
         */
        const createElement = (tag, classes = [], textContent = '') => {
            const el = document.createElement(tag);
            if (Array.isArray(classes)) {
                el.classList.add(...classes);
            } else if (typeof classes === 'string' && classes) {
                el.classList.add(classes);
            }
            if (textContent) {
                el.textContent = textContent;
            }
            return el;
        };


        const setLanguage = (lang) => {
            if (lang !== 'en' && lang !== 'ar') return;
            currentLanguage = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            elements.langEnBtn.classList.toggle('bg-gray-700', lang === 'en');
            elements.langEnBtn.classList.toggle('text-white', lang === 'en');
            elements.langArBtn.classList.toggle('bg-gray-700', lang === 'ar');
            elements.langArBtn.classList.toggle('text-white', lang === 'ar');
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (uiStrings[currentLanguage][key]) el.textContent = uiStrings[currentLanguage][key];
            });
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                if (uiStrings[currentLanguage][key]) el.placeholder = uiStrings[currentLanguage][key];
            });
            renderClientsList(elements.clientSearch.value);
            if(selectedClientId) renderClientDetails(selectedClientId);
        };

        const getInitials = (name) => {
            if (!name) return '?';
            const names = name.trim().split(' ');
            if (names.length > 1 && names[1]) {
                return `${names[0][0]}${names[names.length - 1][0]}`.toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        };

        const renderClientsList = (filter = '') => {
            elements.loaderClients.classList.add('hidden');
            // Clear previous list
            elements.clientsList.innerHTML = '';
            
            if (!hubId) return;

            const filteredClients = clients.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));

            if (filteredClients.length === 0) {
                const p = createElement('p', ['p-4', 'text-sm', 'text-gray-500', 'text-center'], uiStrings[currentLanguage].noClientsFound);
                elements.clientsList.appendChild(p);
                return;
            }

            filteredClients.forEach(client => {
                const itemDiv = createElement('div', ['client-item', 'p-3', 'border-b', 'cursor-pointer', 'hover:bg-gray-100', 'flex', 'items-center', 'space-x-3', 'rtl:space-x-reverse']);
                if (client.id === selectedClientId) {
                    itemDiv.classList.add('selected');
                }
                itemDiv.dataset.id = client.id;
                
                const avatarDiv = createElement('div', ['h-10', 'w-10', 'rounded-full', 'bg-gray-200', 'flex', 'items-center', 'justify-center', 'font-bold', 'text-gray-600', 'flex-shrink-0'], getInitials(client.name));
                
                const textDiv = createElement('div', ['flex-1', 'overflow-hidden']);
                const nameH4 = createElement('h4', ['font-semibold', 'text-gray-800', 'truncate'], client.name);
                const detailP = createElement('p', ['text-sm', 'text-gray-500', 'truncate'], client.company || client.email || '');
                
                textDiv.append(nameH4, detailP);
                itemDiv.append(avatarDiv, textDiv);
                elements.clientsList.appendChild(itemDiv);
            });
        };

        // SECURE: Rewritten to use DOM element creation instead of innerHTML
        const renderClientDetails = (clientId) => {
            const client = clients.find(c => c.id === clientId);
            // Clear previous view
            elements.clientDetailsView.innerHTML = '';

            if (!client) {
                elements.clientDetailsView.classList.add('hidden');
                elements.emptyState.classList.remove('hidden');
                return;
            }

            elements.emptyState.classList.add('hidden');
            elements.clientDetailsView.classList.remove('hidden');

            // --- Header ---
            const headerContainer = createElement('div', ['p-6', 'border-b', 'bg-white']);
            const headerFlex = createElement('div', ['flex', 'justify-between', 'items-start']);
            const clientInfoFlex = createElement('div', ['flex', 'items-center', 'space-x-4', 'rtl:space-x-reverse']);
            const avatar = createElement('div', ['h-16', 'w-16', 'rounded-full', 'bg-gray-700', 'text-white', 'flex', 'items-center', 'justify-center', 'text-2xl', 'font-bold', 'flex-shrink-0'], getInitials(client.name));
            const clientTextInfo = createElement('div');
            const clientName = createElement('h2', ['text-2xl', 'font-bold', 'text-gray-900'], client.name);
            clientTextInfo.appendChild(clientName);
            if(client.company) clientTextInfo.appendChild(createElement('p', ['text-md', 'text-gray-600'], client.company));
            
            const contactInfoDiv = createElement('div', ['text-sm', 'text-gray-500', 'mt-1', 'flex', 'flex-wrap', 'gap-x-4', 'gap-y-1']);
            if(client.email) {
                const emailSpan = createElement('span', ['flex', 'items-center']);
                emailSpan.innerHTML = `<svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>`;
                emailSpan.appendChild(document.createTextNode(client.email));
                contactInfoDiv.appendChild(emailSpan);
            }
            if(client.phone) {
                const phoneSpan = createElement('span', ['flex', 'items-center']);
                phoneSpan.innerHTML = `<svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.518.759a11.024 11.024 0 005.174 5.174l.759-1.518a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg>`;
                phoneSpan.appendChild(document.createTextNode(client.phone));
                contactInfoDiv.appendChild(phoneSpan);
            }
            clientTextInfo.appendChild(contactInfoDiv);
            clientInfoFlex.append(avatar, clientTextInfo);
            
            const buttonGroup = createElement('div', ['flex-col', 'md:flex-row', 'flex', 'space-y-2', 'md:space-y-0', 'md:space-x-2', 'rtl:space-x-reverse']);
            const exportPdfBtn = createElement('button', ['text-sm', 'font-medium', 'text-gray-600', 'hover:text-gray-900', 'p-2', 'rounded-md', 'hover:bg-gray-100'], uiStrings[currentLanguage].exportPDF);
            exportPdfBtn.id = 'export-pdf-btn';
            const exportExcelBtn = createElement('button', ['text-sm', 'font-medium', 'text-gray-600', 'hover:text-gray-900', 'p-2', 'rounded-md', 'hover:bg-gray-100'], uiStrings[currentLanguage].exportExcel);
            exportExcelBtn.id = 'export-excel-btn';
            const editBtn = createElement('button', ['text-sm', 'font-medium', 'text-gray-600', 'hover:text-gray-900', 'p-2', 'rounded-md', 'hover:bg-gray-100'], uiStrings[currentLanguage].edit);
            editBtn.id = 'edit-client-btn';
            const deleteBtn = createElement('button', ['text-sm', 'font-medium', 'text-red-600', 'hover:text-red-900', 'p-2', 'rounded-md', 'hover:bg-red-50'], uiStrings[currentLanguage].delete);
            deleteBtn.id = 'delete-client-btn';
            buttonGroup.append(exportPdfBtn, exportExcelBtn, editBtn, deleteBtn);
            
            headerFlex.append(clientInfoFlex, buttonGroup);
            headerContainer.appendChild(headerFlex);
            
            // --- Body ---
            const bodyContainer = createElement('div', ['p-6', 'space-y-8']);
            
            // Notes
            const notesSection = createElement('div');
            const notesTitle = createElement('h3', ['text-lg', 'font-semibold', 'mb-2'], uiStrings[currentLanguage].notes);
            const notesContent = createElement('div', ['bg-white', 'p-4', 'rounded-lg', 'border', 'min-h-[100px]', 'text-gray-700', 'whitespace-pre-wrap']);
            notesContent.textContent = client.notes || '';
            if (!client.notes) {
                const noNotesSpan = createElement('span', ['text-gray-400'], 'No notes yet.');
                notesContent.appendChild(noNotesSpan);
            }
            notesSection.append(notesTitle, notesContent);

            // Files
            const filesSection = createElement('div');
            const filesHeader = createElement('div', ['flex', 'justify-between', 'items-center', 'mb-4']);
            const filesTitle = createElement('h3', ['text-lg', 'font-semibold'], uiStrings[currentLanguage].files);
            const uploadLabel = createElement('label', ['bg-gray-800', 'text-white', 'px-3', 'py-2', 'rounded-lg', 'text-sm', 'font-semibold', 'cursor-pointer', 'hover:bg-gray-700']);
            uploadLabel.appendChild(createElement('span', [], uiStrings[currentLanguage].uploadFile));
            const fileInput = createElement('input', 'hidden');
            fileInput.type = 'file';
            fileInput.id = 'file-upload-input';
            uploadLabel.appendChild(fileInput);
            filesHeader.append(filesTitle, uploadLabel);
            
            const filesListDiv = createElement('div', ['bg-white', 'p-4', 'rounded-lg', 'border', 'space-y-3']);
            filesListDiv.id = 'files-list';
            if (client.files && client.files.length > 0) {
                client.files.forEach(file => filesListDiv.appendChild(renderFileItem(file)));
            } else {
                filesListDiv.appendChild(createElement('span', ['text-gray-400', 'text-sm'], 'No files uploaded.'));
            }
            filesSection.append(filesHeader, filesListDiv);

            // Tasks
            const tasksSection = createElement('div');
            const tasksHeader = createElement('div', ['flex', 'justify-between', 'items-center', 'mb-4']);
            const tasksTitle = createElement('h3', ['text-lg', 'font-semibold'], uiStrings[currentLanguage].tasks);
            const addTaskBtn = createElement('button', ['bg-gray-800', 'text-white', 'px-3', 'py-2', 'rounded-lg', 'text-sm', 'font-semibold'], uiStrings[currentLanguage].addTask);
            addTaskBtn.id = 'add-task-btn';
            tasksHeader.append(tasksTitle, addTaskBtn);

            const kanbanGrid = createElement('div', ['grid', 'grid-cols-1', 'md:grid-cols-3', 'gap-6']);
            kanbanGrid.appendChild(renderKanbanColumn('todo', uiStrings[currentLanguage].todo, client.tasks || []));
            kanbanGrid.appendChild(renderKanbanColumn('inprogress', uiStrings[currentLanguage].inprogress, client.tasks || []));
            kanbanGrid.appendChild(renderKanbanColumn('done', uiStrings[currentLanguage].done, client.tasks || []));
            
            // --- AI Task Breakdown Feature ---
            const aiFeatureDiv = createElement('div', ['mt-4', 'mb-2', 'p-4', 'bg-blue-50', 'border', 'border-blue-200', 'rounded-lg']);
            const aiInput = createElement('input', ['w-full', 'border', 'border-gray-300', 'rounded-md', 'shadow-sm', 'p-2']);
            aiInput.id = 'ai-goal-input';
            aiInput.type = 'text';
            aiInput.placeholder = uiStrings[currentLanguage].enterGoalPlaceholder;
            
            const aiButton = createElement('button', ['mt-2', 'w-full', 'bg-blue-600', 'text-white', 'px-3', 'py-2', 'rounded-lg', 'text-sm', 'font-semibold', 'hover:bg-blue-700', 'flex', 'items-center', 'justify-center', 'gap-2', 'transition-colors']);
            aiButton.id = 'ai-breakdown-btn';
            aiButton.innerHTML = `✨ <span data-translate="breakDownGoal">${uiStrings[currentLanguage].breakDownGoal.replace('✨ ','')}</span>`;

            aiFeatureDiv.append(aiInput, aiButton);
            tasksSection.append(tasksHeader, aiFeatureDiv, kanbanGrid);

            bodyContainer.append(notesSection, filesSection, tasksSection);
            elements.clientDetailsView.append(headerContainer, bodyContainer);
        };

        const renderKanbanColumn = (status, title, tasks) => {
            const tasksInColumn = tasks.filter(t => t.status === status);
            
            const columnDiv = createElement('div', ['bg-white', 'rounded-lg', 'p-3', 'kanban-column', 'border']);
            columnDiv.dataset.status = status;
            
            const titleH4 = createElement('h4', ['font-semibold', 'mb-3', 'text-center', 'text-gray-700', 'border-b', 'pb-2']);
            titleH4.textContent = `${title} `;
            titleH4.appendChild(createElement('span', ['text-sm', 'text-gray-500'], tasksInColumn.length));
            
            const taskListDiv = createElement('div', ['space-y-3', 'task-list', 'pt-2']);

            if (tasksInColumn.length > 0) {
                tasksInColumn.forEach(task => {
                    const cardDiv = createElement('div', ['bg-white', 'p-3', 'rounded-md', 'shadow-sm', 'border', 'task-card']);
                    cardDiv.draggable = true;
                    cardDiv.dataset.taskId = task.id;
                    cardDiv.dataset.status = task.status;
                    
                    const textP = createElement('p', ['text-sm', 'break-words', 'pr-16'], task.text);
                    
                    const actionsDiv = createElement('div', ['task-actions']);
                    
                    // Status Change Dropdown
                    const statusChangerContainer = createElement('div', 'relative');
                    const statusButton = createElement('button', ['status-change-toggle-btn', 'p-1', 'text-gray-400', 'hover:text-gray-700', 'hover:bg-gray-100', 'rounded-full']);
                    statusButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>`;
                    
                    const statusDropdown = createElement('div', ['status-change-dropdown', 'hidden']);
                    statusDropdown.dataset.taskId = task.id;
                    const statuses = ['todo', 'inprogress', 'done'];
                    statuses.filter(s => s !== task.status).forEach(s => {
                        const optionBtn = createElement('button', 'status-change-option', uiStrings[currentLanguage][s]);
                        optionBtn.dataset.newStatus = s;
                        statusDropdown.appendChild(optionBtn);
                    });
                    
                    statusChangerContainer.append(statusButton, statusDropdown);

                    // Delete button
                    const deleteBtn = createElement('button', ['delete-task-btn', 'p-1', 'rounded-full', 'hover:bg-red-100', 'text-gray-400', 'hover:text-red-600']);
                    deleteBtn.dataset.taskId = task.id;
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
                    
                    actionsDiv.append(statusChangerContainer, deleteBtn);
                    cardDiv.append(textP, actionsDiv);
                    taskListDiv.appendChild(cardDiv);
                });
            } else {
                taskListDiv.appendChild(createElement('div', ['text-xs', 'text-gray-500', 'text-center', 'p-4'], 'Drop tasks here'));
            }
            
            columnDiv.append(titleH4, taskListDiv);
            return columnDiv;
        };

        // SECURE: Rewritten to return a DOM element instead of an HTML string
        const renderFileItem = (file) => {
            const fileItemDiv = createElement('div', ['flex', 'items-center', 'justify-between', 'p-2', 'rounded-md', 'hover:bg-gray-50']);
            const leftDiv = createElement('div', ['flex', 'items-center', 'space-x-3', 'rtl:space-x-reverse', 'flex-1', 'overflow-hidden']);
            
            const iconContainer = createElement('div');
            iconContainer.innerHTML = getFileTypeIcon(file.name);
            
            const textDiv = createElement('div', ['flex-1', 'overflow-hidden']);
            const fileNameP = createElement('p', ['text-sm', 'font-medium', 'text-gray-800', 'truncate'], file.name);
            const fileSizeP = createElement('p', ['text-xs', 'text-gray-500'], formatBytes(file.size));
            textDiv.append(fileNameP, fileSizeP);
            
            leftDiv.append(iconContainer, textDiv);
            
            const rightDiv = createElement('div', ['flex', 'items-center', 'space-x-2', 'rtl:space-x-reverse', 'ml-2']);
            const downloadLink = createElement('a', ['p-1.5', 'text-gray-500', 'hover:text-gray-800', 'hover:bg-gray-200', 'rounded-full']);
            downloadLink.href = file.url;
            downloadLink.target = '_blank';
            downloadLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
            
            const deleteBtn = createElement('button', ['delete-file-btn', 'p-1.5', 'text-red-500', 'hover:text-red-700', 'hover:bg-red-100', 'rounded-full']);
            deleteBtn.dataset.storagePath = file.storagePath;
            deleteBtn.dataset.fileName = file.name;
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
            
            rightDiv.append(downloadLink, deleteBtn);
            fileItemDiv.append(leftDiv, rightDiv);
            return fileItemDiv;
        }

        const handleClientSelect = (e) => {
            const clientItem = e.target.closest('.client-item');
            if (clientItem) {
                selectedClientId = clientItem.dataset.id;
                renderClientsList(elements.clientSearch.value);
                renderClientDetails(selectedClientId);
                if(window.innerWidth < 768) elements.clientListPanel.classList.add('-translate-x-full');
            }
        };

        const handleAddClient = () => {
            elements.clientForm.reset();
            elements.clientIdInput.value = '';
            elements.clientModalTitle.textContent = uiStrings[currentLanguage].addClientTitle;
            elements.clientModal.classList.remove('hidden');
        };

        const handleEditClient = () => {
            const client = clients.find(c => c.id === selectedClientId);
            if(client) {
                elements.clientForm.reset();
                elements.clientIdInput.value = client.id;
                elements.clientNameInput.value = client.name;
                elements.clientCompanyInput.value = client.company || '';
                elements.clientEmailInput.value = client.email || '';
                elements.clientPhoneInput.value = client.phone || '';
                elements.clientNotesInput.value = client.notes || '';
                elements.clientModalTitle.textContent = uiStrings[currentLanguage].editClientTitle;
                elements.clientModal.classList.remove('hidden');
            }
        };

        const handleDeleteClient = () => {
            if (!db) return showToast(uiStrings[currentLanguage].firebaseNotInitialized, 'error');
            showConfirmationModal(
                uiStrings[currentLanguage].confirmDeleteClientTitle,
                uiStrings[currentLanguage].confirmDeleteClientText,
                async () => {
                    try {
                        const client = clients.find(c => c.id === selectedClientId);
                        if (client && client.files && client.files.length > 0) {
                            for (const file of client.files) {
                                const fileRef = ref(storage, file.storagePath);
                                await deleteObject(fileRef).catch(e => console.error(`Failed to delete file ${file.storagePath}`, e));
                            }
                        }
                        const clientRef = doc(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`, selectedClientId);
                        await deleteDoc(clientRef);
                        showToast(uiStrings[currentLanguage].clientDeleted, 'success');
                        selectedClientId = null;
                        renderClientDetails(null);
                    } catch(e) { console.error("Error deleting client: ", e); showToast(uiStrings[currentLanguage].error, 'error'); }
                }
            );
        };

        const handleSaveClient = async (e) => {
            e.preventDefault();
            if (!db) return showToast(uiStrings[currentLanguage].firebaseNotInitialized, 'error');
            const id = elements.clientIdInput.value;
            const clientData = {
                name: elements.clientNameInput.value, 
                company: elements.clientCompanyInput.value,
                email: elements.clientEmailInput.value,
                phone: elements.clientPhoneInput.value, 
                notes: elements.clientNotesInput.value,
            };
            try {
                if (id) {
                    const clientRef = doc(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`, id);
                    await updateDoc(clientRef, clientData);
                } else {
                    const clientCollection = collection(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`);
                    clientData.createdAt = serverTimestamp();
                    clientData.tasks = [];
                    clientData.files = [];
                    await addDoc(clientCollection, clientData);
                }
                showToast(uiStrings[currentLanguage].clientSaved, 'success');
                elements.clientModal.classList.add('hidden');
            } catch (e) { console.error("Error saving client: ", e); showToast(uiStrings[currentLanguage].error, 'error'); }
        };

        const handleAddTask = () => { elements.taskForm.reset(); elements.taskModal.classList.remove('hidden'); };
        const handleSaveTask = async (e) => {
            e.preventDefault();
            if (!db) return showToast(uiStrings[currentLanguage].firebaseNotInitialized, 'error');
            const text = elements.taskTextInput.value;
            if (!text || !selectedClientId) return;
            const client = clients.find(c => c.id === selectedClientId);
            if (!client) return;
            const newTask = { id: `task_${crypto.randomUUID()}`, text: text, status: 'todo' };
            const updatedTasks = [...(client.tasks || []), newTask];
            try {
                const clientRef = doc(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`, selectedClientId);
                await updateDoc(clientRef, { tasks: updatedTasks });
                showToast(uiStrings[currentLanguage].taskAdded, 'success');
                elements.taskModal.classList.add('hidden');
            } catch(e) { console.error("Error adding task: ", e); showToast(uiStrings[currentLanguage].error, 'error'); }
        };
        
        const handleAiTaskBreakdown = async () => {
            const aiButton = document.getElementById('ai-breakdown-btn');
            const aiInput = document.getElementById('ai-goal-input');
            if (!aiButton || !aiInput) return;

            const goal = aiInput.value.trim();
            if (!goal) {
                showToast("Please enter a goal to break down.", 'error');
                return;
            }

            const client = clients.find(c => c.id === selectedClientId);
            if (!client) return;

            const originalButtonContent = aiButton.innerHTML;
            aiButton.disabled = true;
            aiButton.innerHTML = `<span class="h-4 w-4 border-t-2 border-white rounded-full animate-spin"></span><span class="ml-2">${uiStrings[currentLanguage].generatingTasks}</span>`;

            try {
                const taskStrings = await generateTasksWithGemini(goal, client);
                if (!taskStrings || taskStrings.length === 0) {
                    throw new Error("AI did not generate any tasks.");
                }
                
                const newTasks = taskStrings.map(text => ({ 
                    id: `task_${crypto.randomUUID()}`, 
                    text: text, 
                    status: 'todo' 
                }));

                const clientDoc = clients.find(c => c.id === selectedClientId); // Re-fetch latest client state
                const updatedTasks = [...(clientDoc.tasks || []), ...newTasks];
                
                const clientRef = doc(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`, selectedClientId);
                await updateDoc(clientRef, { tasks: updatedTasks });
                
                showToast(uiStrings[currentLanguage].tasksGenerated, 'success');
                aiInput.value = '';
            } catch (error) {
                console.error("Error generating AI tasks:", error);
                showToast(uiStrings[currentLanguage].error, 'error');
            } finally {
                aiButton.disabled = false;
                aiButton.innerHTML = originalButtonContent;
            }
        };

        const generateTasksWithGemini = async (goal, client) => {
            const apiKey = ""; // This will be handled by the environment, leave as an empty string.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert project manager. Your task is to break down a high-level user goal into a concise list of 3 to 7 actionable tasks. Consider the client's information for context if provided. The tasks should be clear, specific, and begin with a verb. Respond ONLY with a valid JSON array of strings, where each string is a task. Do not include any other text, explanations, or markdown formatting. For example: [\"Task 1\", \"Task 2\", \"Task 3\"]";
            const userQuery = `Client Name: ${client.name}\nClient Notes: ${client.notes || 'N/A'}\n\nHigh-Level Goal: "${goal}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    }
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!jsonText) {
                console.error('Invalid response structure from API:', result);
                throw new Error("Invalid or empty response from the AI model.");
            }

            return JSON.parse(jsonText);
        };
        
        const handleAiClientSetup = async () => {
            const text = elements.aiClientSetupInput.value.trim();
            if (!text) {
                showToast("Please paste some client information first.", "error");
                return;
            }

            const originalButtonContent = elements.aiClientSetupBtn.innerHTML;
            elements.aiClientSetupBtn.disabled = true;
            elements.aiClientSetupBtn.innerHTML = `<span class="h-4 w-4 border-t-2 border-white rounded-full animate-spin"></span><span class="ml-2">${uiStrings[currentLanguage].parsingClientInfo}</span>`;
            
            try {
                const clientData = await parseClientInfoWithGemini(text);
                
                // Reset form and open modal
                elements.clientForm.reset();
                elements.clientIdInput.value = '';
                elements.clientModalTitle.textContent = uiStrings[currentLanguage].addClientTitle;
                
                // Pre-fill form
                elements.clientNameInput.value = clientData.name || '';
                elements.clientCompanyInput.value = clientData.company || '';
                elements.clientEmailInput.value = clientData.email || '';
                elements.clientPhoneInput.value = clientData.phone || '';
                elements.clientNotesInput.value = clientData.notes || '';

                elements.clientModal.classList.remove('hidden');
                showToast(uiStrings[currentLanguage].clientInfoParsed, 'success');
                elements.aiClientSetupInput.value = '';

            } catch (error) {
                console.error("Error setting up client with AI:", error);
                showToast(uiStrings[currentLanguage].error, 'error');
            } finally {
                elements.aiClientSetupBtn.disabled = false;
                elements.aiClientSetupBtn.innerHTML = originalButtonContent;
            }
        };

        const parseClientInfoWithGemini = async (text) => {
            const apiKey = ""; // Handled by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert data entry assistant. Your task is to parse unstructured text containing client information and extract it into a structured JSON object. The fields to extract are: 'name', 'company', 'email', 'phone', and 'notes'. If a piece of information is not present, the value should be an empty string. The 'notes' field should contain any extra contextual information. Respond ONLY with the valid JSON object. Do not include any other text, explanations, or markdown formatting.";
            
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            name: { type: "STRING" },
                            company: { type: "STRING" },
                            email: { type: "STRING" },
                            phone: { type: "STRING" },
                            notes: { type: "STRING" },
                        }
                    }
                }
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!jsonText) {
                console.error('Invalid response structure from API:', result);
                throw new Error("Invalid or empty response from the AI model.");
            }
            
            return JSON.parse(jsonText);
        };


        const handleDeleteTask = (taskId) => {
            if (!db) return showToast(uiStrings[currentLanguage].firebaseNotInitialized, 'error');
            showConfirmationModal(uiStrings[currentLanguage].confirmDeleteTaskTitle, uiStrings[currentLanguage].confirmDeleteTaskText,
                async () => {
                    const client = clients.find(c => c.id === selectedClientId);
                    if (!client) return;
                    const updatedTasks = client.tasks.filter(t => t.id !== taskId);
                        try {
                            const clientRef = doc(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`, selectedClientId);
                            await updateDoc(clientRef, { tasks: updatedTasks });
                            showToast(uiStrings[currentLanguage].taskDeleted, 'success');
                        } catch(e) { console.error("Error deleting task: ", e); showToast(uiStrings[currentLanguage].error, 'error'); }
                }
            );
        };

        const handleChangeTaskStatus = async (taskId, newStatus) => {
            if (!db || !selectedClientId) return;
            const client = clients.find(c => c.id === selectedClientId);
            if (!client || !client.tasks) return;

            const updatedTasks = client.tasks.map(task => 
                task.id === taskId ? { ...task, status: newStatus } : task
            );

            try {
                const clientRef = doc(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`, selectedClientId);
                await updateDoc(clientRef, { tasks: updatedTasks });
                showToast(uiStrings[currentLanguage].taskStatusUpdated, 'success');
            } catch(e) {
                console.error("Error updating task status: ", e);
                showToast(uiStrings[currentLanguage].error, 'error');
            }
        };

        let draggedTask = null;
        const handleDragStart = (e) => { if(e.target.classList.contains('task-card')){ draggedTask = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); } };
        const handleDragEnd = () => { if(draggedTask) { draggedTask.classList.remove('dragging'); draggedTask = null; } };
        const handleDragOver = (e) => { e.preventDefault(); const column = e.target.closest('.kanban-column'); if(column) { document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drag-over')); column.classList.add('drag-over'); }};
        const handleDragLeave = (e) => { const column = e.target.closest('.kanban-column'); if(column) column.classList.remove('drag-over'); };
        const handleDrop = async (e) => {
            e.preventDefault();
            const column = e.target.closest('.kanban-column');
            document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drag-over'));
            if (column && draggedTask) {
                const newStatus = column.dataset.status;
                const taskId = draggedTask.dataset.taskId;
                handleChangeTaskStatus(taskId, newStatus);
            }
        };

        const handleFileUpload = (e) => {
            if (!storage) return showToast(uiStrings[currentLanguage].firebaseNotInitialized, 'error');
            const file = e.target.files[0];
            if (!file || !selectedClientId) return;

            elements.uploadProgressModal.classList.remove('hidden');
            const storagePath = `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients/${selectedClientId}/${Date.now()}-${file.name}`;
            const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    elements.uploadProgressBar.style.width = progress + '%';
                    elements.uploadProgressText.textContent = Math.round(progress) + '%';
                }, 
                (error) => {
                    console.error("Upload failed: ", error);
                    showToast(uiStrings[currentLanguage].error, 'error');
                    elements.uploadProgressModal.classList.add('hidden');
                }, 
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        const client = clients.find(c => c.id === selectedClientId);
                        const fileData = {
                            name: file.name,
                            url: downloadURL,
                            size: file.size,
                            type: file.type,
                            storagePath: storagePath
                        };
                        const updatedFiles = [...(client.files || []), fileData];
                        const clientRef = doc(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`, selectedClientId);
                        await updateDoc(clientRef, { files: updatedFiles });

                        showToast(uiStrings[currentLanguage].fileUploaded, 'success');
                        elements.uploadProgressModal.classList.add('hidden');
                        e.target.value = ''; // Reset file input
                    });
                }
            );
        };

        const handleDeleteFile = (storagePath, fileName) => {
            if (!storage || !db) return showToast(uiStrings[currentLanguage].firebaseNotInitialized, 'error');
            showConfirmationModal(uiStrings[currentLanguage].confirmDeleteFileTitle, uiStrings[currentLanguage].confirmDeleteFileText,
                async () => {
                    try {
                        const fileRef = ref(storage, storagePath);
                        await deleteObject(fileRef);

                        const client = clients.find(c => c.id === selectedClientId);
                        const updatedFiles = client.files.filter(f => f.storagePath !== storagePath);
                        const clientRef = doc(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`, selectedClientId);
                        await updateDoc(clientRef, { files: updatedFiles });
                        
                        showToast(uiStrings[currentLanguage].fileDeleted, 'success');

                    } catch (error) {
                        console.error("Error deleting file: ", error);
                        showToast(uiStrings[currentLanguage].error, 'error');
                    }
                }
            );
        };

        const handleExportPDF = () => {
            const client = clients.find(c => c.id === selectedClientId);
            if (!client) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const clientName = client.name || 'No Name';

            doc.setFontSize(22);
            doc.text(clientName, 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(uiStrings[currentLanguage].appTitle, 105, 28, { align: 'center' });
            
            const info = [
                { title: uiStrings[currentLanguage].clientCompany, value: client.company },
                { title: uiStrings[currentLanguage].clientEmail, value: client.email },
                { title: uiStrings[currentLanguage].clientPhone, value: client.phone },
            ].filter(item => item.value);

            doc.autoTable({
                startY: 40,
                head: [[uiStrings[currentLanguage].clientName, client.name]],
                body: info.map(i => [i.title, i.value]),
                theme: 'striped',
                headStyles: { fillColor: [41, 128, 185] },
            });
            let currentY = doc.autoTable.previous.finalY + 15;

            if (client.notes) {
                doc.setFontSize(16);
                doc.text(uiStrings[currentLanguage].notes, 14, currentY);
                currentY += 8;
                doc.setFontSize(10);
                const notes = doc.splitTextToSize(client.notes, 180);
                doc.text(notes, 14, currentY);
                currentY += (notes.length * 5) + 10;
            }

            if (client.tasks && client.tasks.length > 0) {
                    doc.autoTable({
                        startY: currentY,
                        head: [[uiStrings[currentLanguage].taskDescription, uiStrings[currentLanguage].tasks]],
                        body: client.tasks.map(t => [t.text, uiStrings[currentLanguage][t.status.replace(' ','')] || t.status]),
                        theme: 'grid',
                        headStyles: { fillColor: [39, 174, 96] },
                    });
                    currentY = doc.autoTable.previous.finalY + 15;
            }

            if (client.files && client.files.length > 0) {
                    doc.autoTable({
                        startY: currentY,
                        head: [[uiStrings[currentLanguage].files]],
                        body: client.files.map(f => [f.name]),
                        theme: 'grid',
                        headStyles: { fillColor: [80, 80, 80] },
                    });
            }

            doc.save(`${client.name}_Report.pdf`);
        };

        const handleExportExcel = () => {
            const client = clients.find(c => c.id === selectedClientId);
            if (!client) return;

            const summaryData = [
                ['Client Hub Report'], [],
                ['Client Name', client.name],
                ['Company', client.company || 'N/A'],
                ['Email', client.email || 'N/A'],
                ['Phone', client.phone || 'N/A'], [],
                ['Notes', client.notes || 'No notes.']
            ];
            const summary_ws = XLSX.utils.aoa_to_sheet(summaryData);
            summary_ws['A1'].s = { font: { bold: true, sz: 16 }};
            ['A3','A4','A5','A6','A8'].forEach(cell => { if(summary_ws[cell]) summary_ws[cell].s = { font: { bold: true }}; });
            summary_ws['!cols'] = [{ wch: 15 }, { wch: 50 }];

            const tasks = client.tasks || [];
            const tasksData = [
                [uiStrings[currentLanguage].taskDescription, uiStrings[currentLanguage].tasks],
                ...tasks.map(t => [t.text, uiStrings[currentLanguage][t.status] || t.status])
            ];
                const tasks_ws = XLSX.utils.aoa_to_sheet(tasksData);
            tasks_ws['A1'].s = { font: { bold: true }};
            tasks_ws['B1'].s = { font: { bold: true }};
            
            const formula_start_row = tasksData.length + 2;
            XLSX.utils.sheet_add_aoa(tasks_ws, [['Task Status Summary']], {origin: `A${formula_start_row}`});
            tasks_ws[`A${formula_start_row}`].s = { font: { bold: true, sz: 14 }};
            XLSX.utils.sheet_add_aoa(tasks_ws, [[uiStrings[currentLanguage].todo, {f: `COUNTIF(B2:B${tasks.length + 1}, "${uiStrings[currentLanguage].todo}")`}]], {origin: `A${formula_start_row + 1}`});
            XLSX.utils.sheet_add_aoa(tasks_ws, [[uiStrings[currentLanguage].inprogress, {f: `COUNTIF(B2:B${tasks.length + 1}, "${uiStrings[currentLanguage].inprogress}")`}]], {origin: `A${formula_start_row + 2}`});
            XLSX.utils.sheet_add_aoa(tasks_ws, [[uiStrings[currentLanguage].done, {f: `COUNTIF(B2:B${tasks.length + 1}, "${uiStrings[currentLanguage].done}")`}]], {origin: `A${formula_start_row + 3}`});
            tasks_ws['!cols'] = [{ wch: 60 }, { wch: 20 }];

            const files = client.files || [];
            const filesData = [
                [uiStrings[currentLanguage].files, 'Size'],
                ...files.map(f => [f.name, formatBytes(f.size)])
            ];
            const files_ws = XLSX.utils.aoa_to_sheet(filesData);
            files_ws['A1'].s = { font: { bold: true }};
            files_ws['B1'].s = { font: { bold: true }};
            files_ws['!cols'] = [{ wch: 50 }, { wch: 15 }];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, summary_ws, "Client Summary");
            XLSX.utils.book_append_sheet(wb, tasks_ws, "Tasks");
            XLSX.utils.book_append_sheet(wb, files_ws, "Files");
            XLSX.writeFile(wb, `${client.name}_Report.xlsx`);
        };


        const showToast = (message, type = 'success') => {
            elements.toast.textContent = message;
            elements.toast.style.backgroundColor = type === 'success' ? '#10B981' : '#EF4444';
            elements.toast.classList.add('show');
            setTimeout(() => elements.toast.classList.remove('show'), 3000);
        };
        const showConfirmationModal = (title, text, onConfirm) => {
            elements.confirmModalTitle.textContent = title;
            elements.confirmModalText.textContent = text;
            confirmCallback = onConfirm;
            elements.confirmModal.classList.remove('hidden');
        };
        const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const formatBytes = (bytes, decimals = 2) => {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        const getFileTypeIcon = (fileName) => {
            const extension = fileName.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>`;
            if (extension === 'pdf') return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`;
            if (['doc', 'docx', 'pages'].includes(extension)) return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`;
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" /></svg>`;
        };

        const initFirebase = async () => {
            let firebaseConfig;

            if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Error parsing injected Firebase config:", e);
                    showToast("Invalid Firebase configuration provided.", 'error');
                    return;
                }
            } else {
                firebaseConfig = firebaseConfigFromModule;
            }

            try {
                setLogLevel('error');
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase configuration is missing or invalid.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                await setupAuthListener();
            } catch (e) {
                console.error("Firebase init failed:", e);
                showToast(uiStrings[currentLanguage].firebaseConfigError, 'error');
            }
        };

        const setupAuthListener = async () => {
            return new Promise((resolve) => {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        initializeHub();
                        resolve();
                    } else if (typeof __initial_auth_token !== 'undefined') {
                        signInWithCustomToken(auth, __initial_auth_token).catch(err => {
                            console.error("Custom token sign-in failed", err);
                            showToast(uiStrings[currentLanguage].error, 'error');
                        });
                    } else {
                        signInAnonymously(auth).catch(err => {
                            console.error("Anonymous sign-in failed", err);
                            showToast(uiStrings[currentLanguage].error, 'error');
                        });
                    }
                });
            });
        };

        const fetchClients = () => {
            if (clientsUnsubscribe) clientsUnsubscribe();
            if (!hubId || !db) return;
            elements.loaderClients.classList.remove('hidden');
            const clientCollection = collection(db, `artifacts/${getAppId()}/public/data/hubs/${hubId}/clients`);
            clientsUnsubscribe = onSnapshot(clientCollection, (snapshot) => {
                clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                clients.sort((a,b) => a.name.localeCompare(b.name));
                renderClientsList(elements.clientSearch.value);
                if(selectedClientId && clients.some(c => c.id === selectedClientId)) {
                    renderClientDetails(selectedClientId);
                } else if (selectedClientId) {
                    selectedClientId = null;
                    renderClientDetails(null);
                }
            }, (error) => { console.error("Error fetching clients:", error); elements.loaderClients.classList.add('hidden'); });
        };

        const initializeHub = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const hubIdFromUrl = urlParams.get('hub');

            if (hubIdFromUrl) {
                hubId = hubIdFromUrl;
            } else {
                hubId = generateHubId();
                try {
                    const newUrl = `${window.location.pathname}?hub=${hubId}`;
                    window.history.pushState({ path: newUrl }, '', newUrl);
                } catch (e) {
                    console.warn("Could not update URL with history.pushState. This is expected in sandboxed environments and can be ignored.");
                }
            }
            elements.hubIdDisplay.textContent = hubId;
            elements.hubInfoContainer.classList.remove('hidden');
            elements.hubInfoContainer.classList.add('flex');
            fetchClients();
        };

        const generateHubId = () => {
            return Math.random().toString(36).substring(2, 10).toUpperCase();
        };

        const copyHubLink = () => {
            const url = window.location.href;
            // Use the older `execCommand` for wider compatibility in sandboxed environments
            const textArea = document.createElement("textarea");
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(uiStrings[currentLanguage].linkCopied, 'success');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showToast(uiStrings[currentLanguage].error, 'error');
            }
            document.body.removeChild(textArea);
        };

        const addEventListeners = () => {
            elements.langEnBtn.addEventListener('click', () => setLanguage('en'));
            elements.langArBtn.addEventListener('click', () => setLanguage('ar'));
            elements.clientSearch.addEventListener('input', (e) => {
                renderClientsList(e.target.value)
                elements.clearSearchBtn.style.display = e.target.value ? 'block' : 'none';
            });
            elements.clearSearchBtn.addEventListener('click', () => {
                elements.clientSearch.value = '';
                elements.clearSearchBtn.style.display = 'none';
                renderClientsList('');
            });
            elements.addClientBtn.addEventListener('click', handleAddClient);
            elements.aiClientSetupBtn.addEventListener('click', handleAiClientSetup);
            elements.clientsList.addEventListener('click', handleClientSelect);
            elements.clientForm.addEventListener('submit', handleSaveClient);
            elements.cancelClientBtn.addEventListener('click', () => elements.clientModal.classList.add('hidden'));
            elements.taskForm.addEventListener('submit', handleSaveTask);
            elements.cancelTaskBtn.addEventListener('click', () => elements.taskModal.classList.add('hidden'));
            elements.shareBtn.addEventListener('click', copyHubLink);
            elements.copyHubLinkBtn.addEventListener('click', copyHubLink);
            
            elements.clientDetailsView.addEventListener('click', (e) => {
                const targetId = e.target.id;
                if (targetId === 'edit-client-btn') handleEditClient();
                if (targetId === 'delete-client-btn') handleDeleteClient();
                if (targetId === 'add-task-btn') handleAddTask();
                if (targetId === 'export-pdf-btn') handleExportPDF();
                if (targetId === 'export-excel-btn') handleExportExcel();

                if (e.target.closest('#ai-breakdown-btn')) {
                    handleAiTaskBreakdown();
                }

                if (targetId === 'file-upload-input') {
                    e.target.addEventListener('change', handleFileUpload, { once: true });
                }

                const deleteBtn = e.target.closest('.delete-task-btn');
                if (deleteBtn) handleDeleteTask(deleteBtn.dataset.taskId);

                const deleteFileBtn = e.target.closest('.delete-file-btn');
                if(deleteFileBtn) {
                    handleDeleteFile(deleteFileBtn.dataset.storagePath, deleteFileBtn.dataset.fileName);
                }

                // Handle status change dropdown
                const statusToggle = e.target.closest('.status-change-toggle-btn');
                if (statusToggle) {
                    const dropdown = statusToggle.nextElementSibling;
                    const allDropdowns = document.querySelectorAll('.status-change-dropdown');
                    allDropdowns.forEach(d => {
                        if (d !== dropdown) d.classList.add('hidden');
                    });
                    dropdown.classList.toggle('hidden');
                }

                const statusOption = e.target.closest('.status-change-option');
                if (statusOption) {
                    const dropdown = statusOption.closest('.status-change-dropdown');
                    const taskId = dropdown.dataset.taskId;
                    const newStatus = statusOption.dataset.newStatus;
                    handleChangeTaskStatus(taskId, newStatus);
                    dropdown.classList.add('hidden');
                }
            });
            
            // Close status dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.status-change-toggle-btn')) {
                    document.querySelectorAll('.status-change-dropdown').forEach(d => d.classList.add('hidden'));
                }
            });

            elements.confirmCancelBtn.addEventListener('click', () => elements.confirmModal.classList.add('hidden'));
            elements.confirmDeleteBtn.addEventListener('click', () => {
                if(confirmCallback) confirmCallback();
                elements.confirmModal.classList.add('hidden');
            });
            
            elements.app.addEventListener('dragstart', handleDragStart);
            elements.app.addEventListener('dragend', handleDragEnd);
            elements.app.addEventListener('dragover', handleDragOver);
            elements.app.addEventListener('dragleave', handleDragLeave);
            elements.app.addEventListener('drop', handleDrop);
            elements.openPanelBtn.addEventListener('click', () => elements.clientListPanel.classList.remove('-translate-x-full'));
            elements.closePanelBtn.addEventListener('click', () => elements.clientListPanel.classList.add('-translate-x-full'));
        };

        document.addEventListener('DOMContentLoaded', () => { 
            setLanguage('en'); 
            addEventListeners(); 
            initFirebase(); 
        });
    </script>
</body>
</html>

